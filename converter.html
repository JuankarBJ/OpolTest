<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas de Gesti√≥n - OpoTest Pro</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos espec√≠ficos para el convertidor que extienden style.css */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            overflow-x: auto;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            font-family: var(--font-family);
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background-color: var(--bg-body);
            color: var(--primary);
        }

        .tab-btn.active {
            background-color: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        .step-list {
            counter-reset: step;
            list-style: none;
            padding: 0;
        }

        .step-list li {
            position: relative;
            padding-left: 50px;
            margin-bottom: 20px;
        }

        .step-list li::before {
            counter-increment: step;
            content: counter(step);
            position: absolute;
            left: 0;
            top: 0;
            width: 35px;
            height: 35px;
            background-color: var(--primary-light);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 35px;
            font-weight: bold;
        }

        .code-block {
            background-color: #263238;
            color: #eceff1;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-main);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            transition: border-color 0.2s;
            background-color: white;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus {
            border-color: var(--primary);
            outline: none;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-body);
            border-radius: 8px;
        }

        .grid-item {
            aspect-ratio: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .grid-item:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .grid-item.selected {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: monospace;
            resize: vertical;
        }

        .status-msg {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 500;
        }

        .status-msg.success {
            background-color: var(--success-bg);
            color: #2e7d32;
            border: 1px solid var(--success);
        }

        .status-msg.error {
            background-color: var(--danger-bg);
            color: #c62828;
            border: 1px solid var(--danger);
        }

        .tool-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border);
        }

        h2 {
            color: var(--primary);
            border-bottom: 2px solid var(--bg-body);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h3 {
            color: var(--text-secondary);
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--bg-body);
            color: var(--text-main);
            border: 2px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
    </style>
</head>

<body>

    <header>
        <nav>
            <a href="index.html" class="logo">OpoTest Pro</a>
            <div class="nav-links">
                <a href="index.html">Volver al Test</a>
                <a href="#" class="nav-button">Herramientas</a>
            </div>
        </nav>
    </header>

    <main>
        <section class="setup-section" style="background: transparent; box-shadow: none; border: none; padding: 0;">
            <div class="tabs">
                <button class="tab-btn active" onclick="openTab('tab-exam')">1. A√±adir Examen Real</button>
                <button class="tab-btn" onclick="openTab('tab-law')">2. A√±adir Ley</button>
                <button class="tab-btn" onclick="openTab('tab-topic')">3. A√±adir Tema</button>
            </div>
        </section>

        <!-- TAB 1: EXAMEN REAL (ANKI CONVERTER) -->
        <div id="tab-exam" class="tab-content active">
            <div class="tool-card">
                <h2>üèõÔ∏è Generador de Examen Real</h2>
                <p>Convierte un archivo exportado de Anki (.txt) y genera la configuraci√≥n para <code>exams.json</code>.
                </p>

                <div class="form-group">
                    <label for="fileInput">1. Archivo de Anki (.txt)</label>
                    <input type="file" id="fileInput" accept=".txt">
                </div>

                <div class="form-group">
                    <label for="examName">2. Nombre del Examen</label>
                    <input type="text" id="examName" placeholder="Ej: Examen Guadalajara 2024">
                </div>

                <button onclick="processAnkiFile()" class="btn-primary">Procesar Archivo</button>
                <div id="ankiStatus"></div>

                <!-- Resultados Anki -->
                <div id="ankiResults" class="hidden"
                    style="margin-top: 30px; border-top: 2px solid var(--bg-body); padding-top: 20px;">
                    <h3>3. Selecci√≥n de Preguntas</h3>
                    <p>Se han encontrado <strong id="questionCount" style="color: var(--primary);">0</strong> preguntas.
                    </p>

                    <div class="action-bar">
                        <button onclick="downloadDataJSON()" class="btn-secondary">‚¨áÔ∏è Descargar JSON</button>
                        <button class="btn-secondary" onclick="selectAll('ankiGrid')">Seleccionar Todas</button>
                        <button class="btn-secondary" onclick="deselectAll('ankiGrid')">Deseleccionar Todas</button>
                        <span style="align-self: center; margin-left: auto;">Seleccionadas: <strong
                                id="ankiSelectedCount">0</strong></span>
                    </div>

                    <div id="ankiGrid" class="grid-container"></div>

                    <div class="form-group">
                        <label for="examId">ID del Examen</label>
                        <input type="text" id="examId" placeholder="ej: exam-guadalajara-2024">
                    </div>

                    <div class="form-group">
                        <label for="examDesc">Descripci√≥n</label>
                        <input type="text" id="examDesc" placeholder="Breve descripci√≥n del examen">
                    </div>

                    <button onclick="generateExamConfig()" class="btn-primary">Generar C√≥digo</button>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Copia esto en <code>data/exams.json</code>:</label>
                        <textarea id="examOutput" readonly onclick="this.select()"></textarea>
                        <button class="btn-secondary" onclick="copyToClipboard('examOutput')"
                            style="margin-top: 10px; width: 100%;">Copiar al Portapapeles</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: A√ëADIR LEY -->
        <div id="tab-law" class="tab-content">
            <div class="tool-card">
                <h2>‚öñÔ∏è Generador de Ley</h2>
                <p>Genera el bloque de configuraci√≥n para a√±adir una nueva ley a <code>config.json</code>.</p>

                <div class="form-group">
                    <label for="lawFile">1. Cargar JSON de la Ley (Opcional, para autocompletar)</label>
                    <input type="file" id="lawFile" accept=".json" onchange="loadLawFile()">
                    <small style="color: var(--text-muted);">Si cargas el archivo, contaremos las preguntas
                        autom√°ticamente.</small>
                </div>

                <div class="form-group">
                    <label for="lawId">2. ID de la Ley</label>
                    <input type="text" id="lawId" placeholder="ej: ley-39-2015">
                </div>

                <div class="form-group">
                    <label for="lawName">3. Nombre de la Ley</label>
                    <input type="text" id="lawName" placeholder="ej: Ley 39/2015 PAC">
                </div>

                <div class="form-group">
                    <label for="lawPath">4. Ruta del Archivo</label>
                    <input type="text" id="lawPath" placeholder="ej: data/Ley39.json" value="data/">
                </div>

                <div class="form-group">
                    <label for="lawCount">5. Total de Preguntas</label>
                    <input type="number" id="lawCount" placeholder="0">
                </div>

                <div class="form-group">
                    <label for="lawIcon">6. Icono (Texto Corto)</label>
                    <input type="text" id="lawIcon" placeholder="ej: L39">
                </div>

                <button onclick="generateLawConfig()" class="btn-primary">Generar C√≥digo</button>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Copia esto en <code>config.json</code> (dentro de "tests"):</label>
                    <textarea id="lawOutput" readonly onclick="this.select()"></textarea>
                    <button class="btn-secondary" onclick="copyToClipboard('lawOutput')"
                        style="margin-top: 10px; width: 100%;">Copiar al Portapapeles</button>
                </div>
            </div>
        </div>

        <!-- TAB 3: A√ëADIR TEMA -->
        <div id="tab-topic" class="tab-content">
            <div class="tool-card">
                <h2>üìö Generador de Tema</h2>
                <p>Selecciona preguntas de un archivo JSON existente para crear un tema en
                    <code>data/topics.json</code>.</p>

                <div class="form-group">
                    <label for="topicSourceFile">1. Cargar Archivo Fuente (JSON)</label>
                    <input type="file" id="topicSourceFile" accept=".json" onchange="loadTopicSource()">
                </div>

                <div id="topicWorkArea" class="hidden">
                    <div class="form-group">
                        <label for="topicId">2. ID del Tema</label>
                        <input type="text" id="topicId" placeholder="ej: tema-1-constitucion">
                    </div>

                    <div class="form-group">
                        <label for="topicName">3. Nombre del Tema</label>
                        <input type="text" id="topicName" placeholder="ej: Tema 1: La Constituci√≥n">
                    </div>

                    <h3>4. Selecciona las preguntas para este tema</h3>
                    <div class="action-bar">
                        <button class="btn-secondary" onclick="selectAll('topicGrid')">Seleccionar Todas</button>
                        <button class="btn-secondary" onclick="deselectAll('topicGrid')">Deseleccionar Todas</button>
                        <span style="align-self: center; margin-left: auto;">Seleccionadas: <strong
                                id="topicSelectedCount">0</strong></span>
                    </div>

                    <div id="topicGrid" class="grid-container"></div>

                    <button onclick="generateTopicConfig()" class="btn-primary" style="margin-top: 20px;">Generar
                        C√≥digo</button>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Copia esto en <code>data/topics.json</code>:</label>
                        <textarea id="topicOutput" readonly onclick="this.select()"></textarea>
                        <button class="btn-secondary" onclick="copyToClipboard('topicOutput')"
                            style="margin-top: 10px; width: 100%;">Copiar al Portapapeles</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer>
        <p>&copy; 2025 OpoTest Pro. Herramientas de Gesti√≥n.</p>
    </footer>

    <script>
        // --- GLOBAL STATE ---
        let ankiQuestions = [];
        let topicQuestions = [];
        let currentTopicFilename = "";

        // --- TABS ---
        function openTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');

            // Activate button
            const btns = document.querySelectorAll('.tab-btn');
            for (let btn of btns) {
                if (btn.getAttribute('onclick').includes(tabId)) {
                    btn.classList.add('active');
                }
            }
        }

        // --- UTILS ---
        function copyToClipboard(elementId) {
            const copyText = document.getElementById(elementId);
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value).then(() => {
                alert("Copiado al portapapeles");
            });
        }

        function showStatus(elementId, msg, type) {
            const statusDiv = document.getElementById(elementId);
            if (statusDiv) {
                statusDiv.textContent = msg;
                statusDiv.className = 'status-msg ' + type;
            } else {
                alert(msg);
            }
        }

        function renderGrid(containerId, count, onClickCallback) {
            const grid = document.getElementById(containerId);
            grid.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.textContent = i + 1;
                item.dataset.index = i;
                item.onclick = function () {
                    this.classList.toggle('selected');
                    if (onClickCallback) onClickCallback();
                };
                grid.appendChild(item);
            }
        }

        function selectAll(gridId) {
            document.querySelectorAll(`#${gridId} .grid-item`).forEach(item => item.classList.add('selected'));
            updateCounts(gridId);
        }

        function deselectAll(gridId) {
            document.querySelectorAll(`#${gridId} .grid-item`).forEach(item => item.classList.remove('selected'));
            updateCounts(gridId);
        }

        function updateCounts(gridId) {
            const count = document.querySelectorAll(`#${gridId} .grid-item.selected`).length;
            if (gridId === 'ankiGrid') document.getElementById('ankiSelectedCount').textContent = count;
            if (gridId === 'topicGrid') document.getElementById('topicSelectedCount').textContent = count;
        }

        // --- TAB 1: ANKI LOGIC ---
        function processAnkiFile() {
            const fileInput = document.getElementById('fileInput');
            const examNameInput = document.getElementById('examName');

            if (!fileInput.files.length) {
                showStatus('ankiStatus', 'Por favor, selecciona un archivo.', 'error');
                return;
            }

            const examName = examNameInput.value.trim() || "Examen Importado";
            const file = fileInput.files[0];

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    ankiQuestions = parseAnkiContent(e.target.result, examName);
                    if (ankiQuestions.length === 0) throw new Error("No se encontraron preguntas");

                    showStatus('ankiStatus', `¬°√âxito! ${ankiQuestions.length} preguntas procesadas.`, 'success');
                    document.getElementById('questionCount').textContent = ankiQuestions.length;
                    document.getElementById('ankiResults').classList.remove('hidden');

                    // Auto-fill inputs
                    const safeId = 'exam-' + examName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                    document.getElementById('examId').value = safeId;
                    document.getElementById('examDesc').value = `Examen oficial: ${examName}`;

                    renderGrid('ankiGrid', ankiQuestions.length, () => updateCounts('ankiGrid'));
                    selectAll('ankiGrid');

                } catch (err) {
                    showStatus('ankiStatus', 'Error: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseAnkiContent(data, defaultTopic) {
            // Reusing the parsing logic
            const lines = data.split('\n');
            const questions = [];
            for (const line of lines) {
                if (!line.trim() || line.startsWith('#')) continue;
                const parts = line.split('\t');
                if (parts.length < 8) continue;

                let qText = parts[2].trim().replace(/^\d+[\.\-\s]+/, '');
                let tags = parts[parts.length - 1].trim() ? parts[parts.length - 1].trim().split(' ') : [];

                questions.push({
                    id: questions.length + 1,
                    tema: parts[1] || defaultTopic,
                    pregunta: qText,
                    opciones: { "a": parts[3], "b": parts[4], "c": parts[5], "d": parts[6] },
                    respuestaCorrecta: parts[7].toLowerCase(),
                    explicacion: "",
                    tags: tags
                });
            }
            return questions;
        }

        function downloadDataJSON() {
            if (!ankiQuestions.length) return;
            const name = document.getElementById('examName').value.trim() || "Examen";
            const safeName = name.replace(/[^a-z0-9]/gi, '').replace(/\s+/g, '');
            const blob = new Blob([JSON.stringify(ankiQuestions, null, 4)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = safeName + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateExamConfig() {
            const selected = document.querySelectorAll('#ankiGrid .grid-item.selected');
            const indices = Array.from(selected).map(item => parseInt(item.dataset.index));

            if (!indices.length) return alert("Selecciona al menos una pregunta");

            const name = document.getElementById('examName').value.trim();
            const safeName = name.replace(/[^a-z0-9]/gi, '').replace(/\s+/g, '') + '.json';

            const config = {
                "id": document.getElementById('examId').value.trim(),
                "nombre": name,
                "descripcion": document.getElementById('examDesc').value.trim(),
                "total_preguntas": indices.length,
                "fuentes": [{ "archivo": "data/" + safeName, "indices": indices }]
            };

            document.getElementById('examOutput').value = JSON.stringify(config, null, 4);
        }

        // --- TAB 2: LAW LOGIC ---
        function loadLawFile() {
            const file = document.getElementById('lawFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        document.getElementById('lawCount').value = json.length;
                        // Try to guess name from filename
                        const name = file.name.replace('.json', '');
                        document.getElementById('lawPath').value = 'data/' + file.name;
                        if (!document.getElementById('lawId').value) document.getElementById('lawId').value = name.toLowerCase();
                    }
                } catch (err) {
                    alert("Error al leer JSON: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function generateLawConfig() {
            const config = {
                "id": document.getElementById('lawId').value.trim(),
                "nombre": document.getElementById('lawName').value.trim(),
                "valor": document.getElementById('lawPath').value.trim(),
                "total_preguntas": parseInt(document.getElementById('lawCount').value) || 0,
                "icono": document.getElementById('lawIcon').value.trim()
            };
            document.getElementById('lawOutput').value = JSON.stringify(config, null, 4);
        }

        // --- TAB 3: TOPIC LOGIC ---
        function loadTopicSource() {
            const file = document.getElementById('topicSourceFile').files[0];
            if (!file) return;

            currentTopicFilename = file.name;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    topicQuestions = JSON.parse(e.target.result);
                    if (!Array.isArray(topicQuestions)) throw new Error("El archivo no es una lista de preguntas");

                    document.getElementById('topicWorkArea').classList.remove('hidden');
                    renderGrid('topicGrid', topicQuestions.length, () => updateCounts('topicGrid'));

                } catch (err) {
                    alert("Error: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function generateTopicConfig() {
            const selected = document.querySelectorAll('#topicGrid .grid-item.selected');
            const indices = Array.from(selected).map(item => parseInt(item.dataset.index));

            if (!indices.length) return alert("Selecciona preguntas para el tema");

            const config = {
                "id": document.getElementById('topicId').value.trim(),
                "nombre": document.getElementById('topicName').value.trim(),
                "fuentes": [
                    {
                        "archivo": "data/" + currentTopicFilename,
                        "indices": indices
                    }
                ]
            };
            document.getElementById('topicOutput').value = JSON.stringify(config, null, 4);
        }
    </script>
</body>

</html>